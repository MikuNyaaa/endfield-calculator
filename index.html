<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产线分流计算器</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            background: #f5f5f5;
            min-height: 100vh;
            font-size: 13px;
        }
        
        .container {
            background: white;
            border-radius: 4px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #39c5bb;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .usage-counter {
            text-align: center;
            margin-bottom: 15px;
            padding: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .usage-counter .count {
            font-size: 24px;
            font-weight: bold;
            margin: 0 5px;
            color: #ffd700;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .input-group {
            margin-bottom: 8px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 3px;
            color: #555;
            font-size: 12px;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 6px;
            border: 2px solid #ddd;
            border-radius: 3px;
            font-size: 13px;
            box-sizing: border-box;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #39c5bb;
        }
        
        button {
            width: 100%;
            padding: 10px;
            background: #39c5bb;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: normal;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #2da89f;
        }
        
        button:active {
            background: #248c84;
        }
        
        .result-section {
            margin-top: 15px;
        }
        
        .result-header {
            border-bottom: 2px solid #39c5bb;
            padding-bottom: 6px;
            margin-bottom: 8px;
        }
        
        .result-header h2 {
            margin: 0;
            color: #39c5bb;
            font-weight: normal;
            font-size: 1.1em;
        }
        
        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .stat-card {
            background: #fafafa;
            padding: 6px;
            border-radius: 2px;
            border-left: 3px solid #39c5bb;
        }
        
        .stat-label {
            font-size: 10px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        .pipeline-list {
            margin-top: 10px;
        }
        
        .pipeline-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 2px;
            padding: 8px;
            margin-bottom: 6px;
            transition: all 0.2s;
        }
        
        .pipeline-item:hover {
            border-color: #999;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .pipeline-title {
            font-weight: normal;
            font-size: 13px;
            color: #333;
        }
        
        .pipeline-efficiency {
            background: #39c5bb;
            color: white;
            padding: 3px 8px;
            border-radius: 2px;
            font-size: 11px;
        }
        
        .pipeline-splits {
            color: #666;
            line-height: 1.5;
            font-size: 12px;
        }
        
        .split-badge {
            display: inline-block;
            background: #e0e0e0;
            color: #333;
            padding: 2px 6px;
            border-radius: 2px;
            margin-right: 4px;
            font-size: 11px;
        }
        
        .description {
            background: #fafafa;
            padding: 10px;
            border-radius: 2px;
            margin-bottom: 10px;
            border-left: 3px solid #39c5bb;
            font-size: 12px;
        }
        
        .description h3 {
            margin-top: 0;
            color: #39c5bb;
            font-weight: normal;
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        
        .description p {
            margin: 5px 0;
        }
        
        .description ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        
        .description li {
            margin: 3px 0;
        }
        
        .no-solution {
            background: #fafafa;
            color: #666;
            padding: 12px;
            border-radius: 2px;
            text-align: center;
            border: 1px solid #e0e0e0;
            font-size: 12px;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .left-panel {
            display: flex;
            flex-direction: column;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .pipeline-section {
            grid-column: 1 / -1;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                font-size: 12px;
            }
            
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.3em;
                margin-bottom: 10px;
            }
            
            .main-layout {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .description {
                font-size: 11px;
            }
            
            .description h3 {
                font-size: 1em;
            }
            
            .input-section {
                padding: 8px;
            }
            
            input[type="number"], select {
                padding: 8px;
                font-size: 14px;
            }
            
            button {
                padding: 12px;
                font-size: 15px;
            }
            
            .result-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
            }
            
            .stat-card {
                padding: 5px;
            }
            
            .stat-label {
                font-size: 9px;
            }
            
            .stat-value {
                font-size: 13px;
            }
            
            .result-header h2 {
                font-size: 1em;
            }
            
            .pipeline-item {
                padding: 6px;
            }
            
            .pipeline-title {
                font-size: 12px;
            }
            
            .pipeline-efficiency {
                font-size: 10px;
                padding: 2px 6px;
            }
            
            .pipeline-splits {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>产线分流计算器</h1>
        <div class="usage-counter">
            累计使用次数：<span class="count" id="usageCount">-</span> 次
        </div>
        
        <div class="main-layout">
            <div class="left-panel">
                <div class="description">
                    <h3>使用说明</h3>
                    <p><strong>功能：</strong>根据电力参数计算放电时间，并通过组合使用 1/2分流、1/3分流 和 2/3分流 来精确匹配目标输出效率。</p>
                    <p><strong>输入：</strong></p>
                    <ul>
                        <li><strong>满转消耗(x)：</strong>热能池全开时游戏上方数字 x/y 中的 x</li>
                        <li><strong>满转生产(y)：</strong>热能池全开时游戏上方数字 x/y 中的 y</li>
                        <li><strong>电池供电量(z)：</strong>单个电池的供电量</li>
                    </ul>
                    <p><strong>计算逻辑：</strong></p>
                    <ul>
                        <li>电池总容量：100000</li>
                        <li>充电时每秒增加：y - x</li>
                        <li>充电时间固定：40秒</li>
                        <li>40秒内充满电量 = min((y - x) × 40, 100000)</li>
                        <li>掉电速率 = x - (y - z)</li>
                        <li>最佳掉电时间 = 40秒内充满电量 / 掉电速率</li>
                        <li>目标效率 = 最佳掉电时间 + 40秒</li>
                    </ul>
                    <p><strong>输出：</strong>具体的分流方案和实际效率（基础速度为 2秒/个）。</p>
                    <p><strong>注意：</strong>本计算器基于从仓库拉取产线进行计算，而非从电池制造设备拉出。仓库产线具有最高运输效率和更好的可操控性。</p>
                </div>
            </div>
            
            <div class="right-panel">
        <div class="input-section">
            <div class="input-group">
                <label for="consumption">满转消耗 (x):</label>
                <input type="number" id="consumption" min="1" step="1" placeholder="输入满转消耗" oninput="validatePositiveInteger(this)" onkeypress="return isNumberKey(event)">
            </div>
            
            <div class="input-group">
                <label for="production">满转生产 (y):</label>
                <input type="number" id="production" min="1" step="1" placeholder="输入满转生产" oninput="validatePositiveInteger(this)" onkeypress="return isNumberKey(event)">
            </div>
            
            <div class="input-group">
                <label for="battery">电池供电量 (z):</label>
                <select id="battery">
                    <option value="" disabled selected>请选择电池类型</option>
                    <option value="220">低谷地电 (220)</option>
                    <option value="420">中谷地电 (420)</option>
                    <option value="1100">高谷地电 (1100)</option>
                    <option value="1600">低武陵电 (1600)</option>
                </select>
            </div>
            
            <button onclick="calculate()">计算分流方案</button>
            
            <div class="result-section" id="result">
                <div class="result-header">
                    <h2>计算结果</h2>
                </div>
                <div class="result-stats" id="stats"></div>
            </div>
            </div>
        </div>
        
        <div class="pipeline-section" id="pipelineSection" style="display: none;">
            <div class="result-header">
                <h2>分流方案</h2>
            </div>
            <div class="pipeline-list" id="pipelineList"></div>
        </div>
        </div>
    </div>

    <script>
        // 页面加载时初始化使用计数
        window.addEventListener('DOMContentLoaded', function() {
            loadUsageCount();
        });
        
        // 加载使用次数（使用 api.counterapi.dev）
        async function loadUsageCount() {
            try {
                const response = await fetch('https://api.counterapi.dev/v1/endfield-calculator/usage/up', {
                    method: 'GET'
                });
                const data = await response.json();
                document.getElementById('usageCount').textContent = data.count || 0;
            } catch (error) {
                console.log('无法加载使用次数:', error);
                // 降级到本地存储显示
                const localCount = localStorage.getItem('endfield-calculator-usage') || 0;
                document.getElementById('usageCount').textContent = localCount + ' (本地)';
            }
        }
        
        // 增加使用次数
        async function incrementUsageCount() {
            try {
                const response = await fetch('https://api.counterapi.dev/v1/endfield-calculator/usage/up', {
                    method: 'POST'
                });
                const data = await response.json();
                document.getElementById('usageCount').textContent = data.count;
            } catch (error) {
                console.log('无法更新使用次数:', error);
                // 降级到本地存储
                const currentCount = parseInt(localStorage.getItem('endfield-calculator-usage') || 0);
                const newCount = currentCount + 1;
                localStorage.setItem('endfield-calculator-usage', newCount);
                document.getElementById('usageCount').textContent = newCount + ' (本地)';
            }
        }
        
        // 验证只能输入数字键
        function isNumberKey(evt) {
            const charCode = (evt.which) ? evt.which : evt.keyCode;
            // 允许数字0-9
            if (charCode >= 48 && charCode <= 57) {
                return true;
            }
            // 阻止其他字符（包括负号、小数点等）
            evt.preventDefault();
            return false;
        }
        
        // 验证输入为正整数
        function validatePositiveInteger(input) {
            let value = input.value;
            
            // 移除所有非数字字符
            value = value.replace(/[^0-9]/g, '');
            
            // 移除前导零
            if (value.length > 1 && value[0] === '0') {
                value = value.replace(/^0+/, '');
            }
            
            // 如果为空，设为空字符串
            if (value === '') {
                input.value = '';
                return;
            }
            
            // 转换为数字并验证
            const numValue = parseInt(value, 10);
            
            // 确保大于0
            if (numValue <= 0) {
                input.value = '';
                return;
            }
            
            input.value = numValue.toString();
        }
        
        function calculate() {
            // 增加使用计数
            incrementUsageCount();
            
            const x = parseFloat(document.getElementById('consumption').value);
            const y = parseFloat(document.getElementById('production').value);
            const z = parseFloat(document.getElementById('battery').value);
            
            // 验证输入是否为空或无效
            if (!x || !y || !z) {
                alert('请填写所有必填项！');
                return;
            }
            
            // 验证是否为正数
            if (x <= 0 || y <= 0 || z <= 0) {
                alert('所有数值必须大于0！');
                return;
            }
            
            // 验证是否为整数
            if (!Number.isInteger(x) || !Number.isInteger(y) || !Number.isInteger(z)) {
                alert('请输入整数！');
                return;
            }
            
            // 检查满转生产是否至少大于1节电池供电量
            if (y <= z) {
                alert('满转生产必须至少大于1节选定的电池供电量！\n当前满转生产: ' + y + '\n当前电池供电量: ' + z + '\n最小要求: ' + (z + 1));
                return;
            }
            
            // 检查是否能充满电
            if (y <= x) {
                alert('满转生产必须大于满转消耗，否则无法充电！');
                return;
            }
            
            // 检查掉电速率 = x - (y - z)
            const dischargeRate = x - (y - z);
            if (dischargeRate <= 0) {
                alert('掉电速率必须大于0，请调整参数！');
                return;
            }
            
            // 计算40秒内充满的电量
            const maxCapacity = 100000;
            const chargeRate = y - x;
            const chargeIn40Seconds = chargeRate * 40;
            const fullCharge = Math.min(chargeIn40Seconds, maxCapacity);
            
            // 计算最佳掉电时间 = 40秒内充满的电量 / 掉电速率
            const dischargeTime = fullCharge / dischargeRate;
            
            // 目标效率 = 放电时间 + 40秒
            const targetEfficiency = dischargeTime + 40;
            
            // 目标速率
            const targetRate = 1 / targetEfficiency;
            
            // 为产线生成可能的分流组合
            const solutions = findBestSplit(targetRate);
            
            displayResults(x, y, z, chargeRate, fullCharge, dischargeTime, targetEfficiency, solutions);
        }
        
        function findBestSplit(targetRate) {
            // 目标时间 = 1 / 目标速率
            const targetTime = 1 / targetRate;
            
            // 从目标时间反向推导最佳分流组合
            return findOptimalSplitFromTime(targetTime);
        }
        
        function findOptimalSplitFromTime(targetTime) {
            // 基础时间是2秒/个
            const baseTime = 2;
            
            // 如果目标时间小于等于基础时间，不需要分流
            if (targetTime <= baseTime) {
                return {
                    pipeline: {
                        splits: [],
                        rate: 1 / baseTime,
                        time: baseTime
                    },
                    totalRate: 1 / baseTime,
                    totalTime: baseTime
                };
            }
            
            // 计算需要的倍数
            const multiplier = targetTime / baseTime;
            
            // 使用贪心算法找到最接近的 2^a × 3^b × (3/2)^c 组合
            const best = findBestMultiplier(multiplier);
            
            // 构建分流数组
            const splits = [];
            for (let i = 0; i < best.count3; i++) splits.push(3);
            for (let i = 0; i < best.count2; i++) splits.push(2);
            for (let i = 0; i < best.count3_2; i++) splits.push(3/2);
            
            const actualTime = baseTime * best.actualMultiplier;
            const actualRate = 1 / actualTime;
            
            return {
                pipeline: {
                    splits: splits,
                    rate: actualRate,
                    time: actualTime
                },
                totalRate: actualRate,
                totalTime: actualTime
            };
        }
        
        function findBestMultiplier(targetMultiplier) {
            // 找到最接近 targetMultiplier 的 2^a × 3^b × (3/2)^c
            // 使用对数来计算：log(target) = a*log(2) + b*log(3) + c*log(3/2)
            
            const log2 = Math.log(2);
            const log3 = Math.log(3);
            const log3_2 = Math.log(3/2);
            const logTarget = Math.log(targetMultiplier);
            
            let bestDiff = Infinity;
            let bestCount2 = 0;
            let bestCount3 = 0;
            let bestCount3_2 = 0;
            let bestMultiplier = 1;
            
            // 限制搜索范围以提高效率
            const maxPower = Math.ceil(logTarget / Math.min(log2, log3, log3_2)) + 5;
            
            for (let count3 = 0; count3 <= maxPower; count3++) {
                for (let count2 = 0; count2 <= maxPower; count2++) {
                    for (let count3_2 = 0; count3_2 <= maxPower; count3_2++) {
                        const multiplier = Math.pow(2, count2) * Math.pow(3, count3) * Math.pow(3/2, count3_2);
                        
                        // 只考虑小于等于目标的倍数（速度要快于或等于目标）
                        if (multiplier <= targetMultiplier) {
                            const diff = Math.abs(multiplier - targetMultiplier);
                            
                            if (diff < bestDiff) {
                                bestDiff = diff;
                                bestCount2 = count2;
                                bestCount3 = count3;
                                bestCount3_2 = count3_2;
                                bestMultiplier = multiplier;
                            }
                        }
                    }
                }
            }
            
            // 如果没找到小于等于目标的（只有基础情况会出现），返回基础值
            if (bestDiff === Infinity) {
                bestCount2 = 0;
                bestCount3 = 0;
                bestCount3_2 = 0;
                bestMultiplier = 1;
            }
            
            return {
                count2: bestCount2,
                count3: bestCount3,
                count3_2: bestCount3_2,
                actualMultiplier: bestMultiplier
            };
        }
        
        function displayResults(x, y, z, chargeRate, fullCharge, dischargeTime, targetEfficiency, solutions) {
            const resultSection = document.getElementById('result');
            const statsDiv = document.getElementById('stats');
            const pipelineListDiv = document.getElementById('pipelineList');
            
            if (!solutions.pipeline) {
                pipelineListDiv.innerHTML = '<div class="no-solution">无法找到合适的分流方案</div>';
                document.getElementById('pipelineSection').style.display = 'block';
                return;
            }
            
            // 显示统计信息
            const actualRate = solutions.totalRate;
            const actualTime = solutions.totalTime;
            
            // 检查实际效率是否小于等于40秒
            if (actualTime <= 40) {
                alert('计算出的实际效率不能小于等于40秒！\n当前实际效率为 ' + actualTime.toFixed(2) + ' 秒/个\n目标效率为 ' + targetEfficiency.toFixed(2) + ' 秒/个\n\n这意味着分流方案过于激进，导致生产周期比充电周期还短。\n请调整输入参数（增大电池供电量或调整其他参数）。');
                return;
            }
            
            const efficiency = actualTime > 0 ? (actualTime / targetEfficiency * 100).toFixed(2) : '0.00';
            
            // 计算每天节省的电池数量（个）
            // 实际效率时间包含了充电40秒 + 掉电生产时间
            // 一天能跑多少个周期
            const cyclesPerDay = 86400 / actualTime;
            // 每个周期的实际掉电时间 = 实际效率时间 - 充电40秒
            const actualDischargeTime = actualTime - 40;
            // 一天掉电总时间（这段时间不需要外接电池！）
            const totalDischargeTime = cyclesPerDay * actualDischargeTime;
            // 掉电时间就是省下来的电池数量（每40秒省1个）
            const batterySavedPerDay = totalDischargeTime / 40;
            
            // 计算节省的金钱
            const batteryPrices = {
                220: { value: 16, unit: '谷地券' },
                420: { value: 30, unit: '谷地券' },
                1100: { value: 70, unit: '谷地券' },
                1600: { value: 25, unit: '武陵券' }
            };
            const priceInfo = batteryPrices[z] || { value: 0, unit: '券' };
            const moneySavedPerDay = batterySavedPerDay * priceInfo.value;
            
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">满电消耗 (x)</div>
                    <div class="stat-value">${x.toFixed(0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">满电产出 (y)</div>
                    <div class="stat-value">${y.toFixed(0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">电池供电 (z)</div>
                    <div class="stat-value">${z.toFixed(0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">充电速率 (y-x)</div>
                    <div class="stat-value">${chargeRate.toFixed(0)}/秒</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">40秒充满电量</div>
                    <div class="stat-value">${fullCharge.toFixed(0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">掉电速率 x-(y-z)</div>
                    <div class="stat-value">${(x - (y - z)).toFixed(0)}/秒</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">最佳掉电时间</div>
                    <div class="stat-value">${dischargeTime.toFixed(2)} 秒</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">目标效率</div>
                    <div class="stat-value">${targetEfficiency.toFixed(2)} 秒/个</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">实际效率</div>
                    <div class="stat-value" style="color: ${actualTime < targetEfficiency ? '#39c5bb' : '#e53935'}">${actualTime.toFixed(4)} 秒/个</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">效率比例</div>
                    <div class="stat-value" style="color: ${parseFloat(efficiency) <= 100 ? '#39c5bb' : '#e53935'}">${efficiency}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">实际速率</div>
                    <div class="stat-value">${actualRate.toFixed(6)} 个/秒</div>
                </div>
                <div class="stat-card" style="border-left-color: #4caf50;">
                    <div class="stat-label">每天节省电池</div>
                    <div class="stat-value" style="color: #4caf50;">${batterySavedPerDay.toFixed(1)} 个</div>
                </div>
                <div class="stat-card" style="border-left-color: #ff9800;">
                    <div class="stat-label">每天节省调度券</div>
                    <div class="stat-value" style="color: #ff9800;">${moneySavedPerDay.toFixed(0)} ${priceInfo.unit}</div>
                </div>
            `;
            
            // 显示分流方案
            const pipelineSectionDiv = document.getElementById('pipelineSection');
            const pipeline = solutions.pipeline;
            
            // 统计并合并相同的分流
            let splitsText;
            if (pipeline.splits.length > 0) {
                const splitCounts = {};
                pipeline.splits.forEach(s => {
                    const key = s === 3/2 ? '1.5' : s.toString();
                    splitCounts[key] = (splitCounts[key] || 0) + 1;
                });
                
                const splitParts = [];
                if (splitCounts['3']) {
                    const label = splitCounts['3'] === 1 ? '1/3' : `1/3 × ${splitCounts['3']}`;
                    splitParts.push(`<span class="split-badge">${label}</span>`);
                }
                if (splitCounts['2']) {
                    const label = splitCounts['2'] === 1 ? '1/2' : `1/2 × ${splitCounts['2']}`;
                    splitParts.push(`<span class="split-badge">${label}</span>`);
                }
                if (splitCounts['1.5']) {
                    const label = splitCounts['1.5'] === 1 ? '2/3' : `2/3 × ${splitCounts['1.5']}`;
                    splitParts.push(`<span class="split-badge">${label}</span>`);
                }
                
                splitsText = splitParts.join(' → ');
            } else {
                splitsText = '<span class="split-badge">无分流</span>';
            }
            
            const timeDisplay = pipeline.time ? `${pipeline.time}秒/个` : '2秒/个';
            
            let html = `
                <div class="pipeline-item">
                    <div class="pipeline-header">
                        <div class="pipeline-title">分流配置</div>
                        <div class="pipeline-efficiency">${timeDisplay}</div>
                    </div>
                    <div class="pipeline-splits">
                        <strong>分流设置：</strong>${splitsText}
                    </div>
                    <div class="pipeline-splits">
                        <strong>速率：</strong>${pipeline.rate.toFixed(6)} 个/秒
                    </div>
                    <div class="pipeline-splits">
                        <strong>效率：</strong>${pipeline.time.toFixed(4)} 秒/个
                    </div>
                </div>
            `;
            
            pipelineListDiv.innerHTML = html;
            pipelineSectionDiv.style.display = 'block';
            
            // 滚动到结果区域
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
    
    <footer style="text-align: center; margin-top: 20px; padding: 15px; color: #999; font-size: 12px; border-top: 1px solid #e0e0e0;">
        <div>作者：MikuNya</div>
        <div style="margin-top: 5px;">终末地ID：1807423708</div>
    </footer>
</body>
</html>
